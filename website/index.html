<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evo - Your AI Companion</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(-45deg, #1a202c, #2d3748, #4a5568, #2d3748);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* A single class to hide our main page views */
        .page-view { display: none; }
        /* Tooltip styles */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .legal-content h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .legal-content p { margin-bottom: 1rem; color: #d1d5db; }
        .legal-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; color: #d1d5db; }
    </style>
</head>
<body class="gradient-bg text-white antialiased">

    <!-- This container will hold all our different pages -->
    <div class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- =============================================================== -->
        <!-- PAGE 1: LANDING PAGE                                            -->
        <!-- =============================================================== -->
        <div id="landing-page" class="w-full">
            <div class="w-full max-w-2xl text-center bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-2xl p-8 md:p-12 shadow-2xl mx-auto">
                <div class="mb-6">
                    <svg class="mx-auto h-16 w-16 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                </div>
                <h1 class="text-5xl md:text-7xl font-black text-white tracking-tighter mb-4">Evo</h1>
                <p class="text-lg md:text-xl text-gray-300 mb-8">An AI companion that learns, remembers, and grows with your community.</p>
                <div class="flex flex-col items-center space-y-4 w-full">
                    <a id="login-btn" href="#" class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105 text-center">
                        Sign In with Discord
                    </a>
                </div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- PAGE 2: SERVER DASHBOARD                                        -->
        <!-- =============================================================== -->
        <div id="server-dashboard" class="page-view w-full max-w-4xl relative">
            <div class="absolute top-0 right-0 mt-2 mr-2 flex items-center space-x-4">
                <div id="user-info" class="text-right">
                    <p class="font-bold text-white">Not Logged In</p>
                    <p class="text-xs text-gray-400">#0000</p>
                </div>
                <button id="logout-btn" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition-colors">
                    Logout
                </button>
            </div>
            <h1 class="text-4xl font-bold text-center mb-8">Your Servers</h1>
            <div id="server-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
                <div id="add-server-card" class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl aspect-square flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-600 hover:border-indigo-400 hover:bg-gray-700 transition-all">
                    <div class="text-center">
                        <svg class="w-16 h-16 text-gray-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <p class="mt-2 font-semibold text-gray-400">Add Server</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- =============================================================== -->
        <!-- PAGE 3: SERVER SETTINGS                                         -->
        <!-- =============================================================== -->
        <div id="server-settings" class="page-view w-full max-w-2xl">
            <button id="back-to-dashboard-btn" class="mb-6 text-indigo-400 hover:text-indigo-300 font-semibold">&larr; Back to Dashboard</button>
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl p-8 shadow-2xl">
                <div class="flex items-center mb-6">
                    <img id="settings-server-icon" src="https://placehold.co/64x64/7f9cf5/ffffff?text=S" alt="Server Icon" class="w-16 h-16 rounded-full mr-4">
                    <h1 id="settings-server-name" class="text-3xl font-bold">Server Name</h1>
                </div>
                
                <div class="space-y-6">
                    <!-- API & Model Settings -->
                    <div class="space-y-6">
                        <div>
                            <label for="ai-model" class="block text-sm font-medium text-gray-300 mb-1">AI Model Name</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="ai-model" placeholder="gemini-2.5-flash-lite" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <button id="use-recommended-model-btn" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-3 rounded-md whitespace-nowrap">Use Recommended</button>
                                <div class="tooltip">
                                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <span class="tooltiptext">gemini-2.5-flash-lite is a recommended model by Evo developers for its balance of speed and intelligence.</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                            <p class="text-sm text-gray-300 text-center sm:text-left">Don't have your own API key? Create a free one in Google AI Studio.</p>
                            <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                Create API Key
                            </a>
                        </div>
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-300 mb-1">API Key</label>
                            <div class="flex items-center space-x-2">
                                <input type="password" id="api-key" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onkeyup="updateKeyDisplay('api-key', 'api-key-display')">
                                <span id="api-key-display" class="bg-gray-700 text-xs font-mono px-2 py-1 rounded">None</span>
                            </div>
                        </div>
                        <div>
                            <label for="backup-api-key" class="block text-sm font-medium text-gray-300 mb-1">Backup API Key (Optional)</label>
                            <div class="flex items-center space-x-2">
                                <input type="password" id="backup-api-key" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onkeyup="updateKeyDisplay('backup-api-key', 'backup-api-key-display')">
                                <span id="backup-api-key-display" class="bg-gray-700 text-xs font-mono px-2 py-1 rounded">None</span>
                            </div>
                        </div>
                    </div>

                    <!-- Premium Section -->
                    <div class="pt-6 border-t border-gray-700">
                        <div id="premium-section-wrapper" class="relative">
                            <div id="premium-fields" class="space-y-6">
                                <div>
                                    <label for="custom-name" class="block text-sm font-medium text-gray-300 mb-1">Custom Name</label>
                                    <input type="text" id="custom-name" placeholder="Evo" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Avatar</label>
                                    <div class="mt-2 flex items-center gap-x-3">
                                        <img id="avatar-preview" src="https://placehold.co/64x64/4a5568/ffffff?text=Evo" class="h-16 w-16 rounded-full text-gray-500" />
                                        <button type="button" class="rounded-md bg-white/10 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-white/20">Click to upload</button>
                                    </div>
                                </div>
                                <div>
                                    <label for="custom-personality" class="block text-sm font-medium text-gray-300 mb-1">Custom Personality</label>
                                    <textarea id="custom-personality" rows="5" placeholder="You are Evo. Your persona is that of a sharp-witted and humorous tomboy..." class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                            </div>
                            <div id="premium-overlay" class="absolute inset-0 bg-gray-900/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-lg p-6 text-center">
                                <h3 class="text-2xl font-bold text-indigo-300">Evo Premium</h3>
                                <ul class="my-4 space-y-2 text-gray-300 list-inside">
                                    <li>✓ Custom Name</li>
                                    <li>✓ Custom Personality</li>
                                    <li>✓ Custom Avatar</li>
                                </ul>
                                <button id="subscribe-btn" class="mt-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform hover:scale-105">
                                    Subscribe 2.99€/month
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="pt-6 border-t border-gray-700 flex flex-col sm:flex-row gap-4">
                        <button id="save-settings-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Save Settings</button>
                        <button id="remove-server-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Remove Server</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LEGAL PAGES -->
        <div id="terms-page" class="page-view w-full max-w-3xl">
            <button class="go-back-btn mb-6 text-indigo-400 hover:text-indigo-300 font-semibold">&larr; Go Back</button>
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl p-8 shadow-2xl legal-content">
                <h1 class="text-3xl font-bold mb-4">Terms of Service</h1>
                <p><strong>Last Updated: July 30, 2025</strong></p>
                <p>Welcome to Evo! These terms and conditions outline the rules and regulations for the use of Evo's services. By adding Evo to your server or using our website, you accept these terms and conditions. Do not continue to use Evo if you do not agree to all of the terms and conditions stated on this page.</p>
                <h2>1. The Service</h2>
                <p>Evo ("the Service") is a Discord bot that provides conversational AI features. The Service requires a user-provided API key from a third-party AI provider (e.g., Google AI Studio) to function. Premium features, such as custom personalities and avatars, are available via a subscription.</p>
                <h2>2. User Responsibilities</h2>
                <ul>
                    <li>You are responsible for the security and usage of your third-party AI API key. We securely encrypt your key but are not liable for any charges incurred on your key.</li>
                    <li>You agree not to use the Service to generate, promote, or engage in any content that is illegal, harmful, harassing, or violates Discord's Terms of Service.</li>
                    <li>You must have the necessary permissions (i.e., Administrator rights) to add and configure Evo on a Discord server.</li>
                </ul>
                <h2>3. Premium Services</h2>
                <p>Premium features are offered on a subscription basis. Payments are handled by a third-party payment processor. We reserve the right to change our subscription fees upon 30 days' notice.</p>
                <h2>4. Termination</h2>
                <p>We may terminate or suspend your access to our Service immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach the Terms. You can remove the bot from your server at any time.</p>
                <h2>5. Disclaimer</h2>
                <p>The Service is provided on an "AS IS" and "AS AVAILABLE" basis. Evo is a third-party application and is not affiliated with, endorsed, or sponsored by Discord Inc.</p>
            </div>
        </div>
        <div id="privacy-page" class="page-view w-full max-w-3xl">
            <button class="go-back-btn mb-6 text-indigo-400 hover:text-indigo-300 font-semibold">&larr; Go Back</button>
            <div class="bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl p-8 shadow-2xl legal-content">
                <h1 class="text-3xl font-bold mb-4">Privacy Policy</h1>
                <p><strong>Last Updated: July 30, 2025</strong></p>
                <p>Your privacy is important to us. It is Evo's policy to respect your privacy regarding any information we may collect from you.</p>
                <h2>1. Information We Collect</h2>
                <ul>
                    <li><strong>Discord Information:</strong> When you log in, we receive your Discord user ID, username, and a list of servers you are in. We only use this to provide our service and do not share it.</li>
                    <li><strong>Server Configurations:</strong> We store the settings you configure for your server, including the server ID, chosen AI model, and custom personality settings.</li>
                    <li><strong>User-Provided API Keys:</strong> We require you to provide an API key from a third-party AI provider. We store these keys in an encrypted format and only use them to make AI requests on your behalf for your server. We do not log the content of your conversations with the AI.</li>
                </ul>
                <h2>2. How We Use Information</h2>
                <p>We use the information we collect to operate, maintain, and provide the features and functionality of the Service. We do not sell or share your personal information with third parties, except as required by law.</p>
                <h2>3. Data Storage and Security</h2>
                <p>Your data, including encrypted API keys and server configurations, is stored on secure servers provided by Firebase (a Google company). We take reasonable measures to protect your information from unauthorized access or disclosure.</p>
                <h2>4. Your Rights</h2>
                <p>You have the right to remove your data from our service at any time by removing the bot from your server and using the "Remove Server" button on our dashboard, which will delete your server's configuration from our database.</p>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="w-full text-center p-4 text-gray-500">
        <div class="space-x-4">
            <button id="terms-link" class="hover:text-gray-300">Terms of Service</button>
            <span>&bull;</span>
            <button id="privacy-link" class="hover:text-gray-300">Privacy Policy</button>
        </div>
    </footer>


    <!-- MODALS -->
    <div id="add-server-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-2xl font-bold">Select a Server</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-server-list" class="p-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <div id="remove-confirm-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold mb-4">Are you sure?</h2>
            <p class="text-gray-300 mb-6">All settings for this server will be permanently lost. This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-remove-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg">Cancel</button>
                <button id="confirm-remove-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg">Confirm & Remove</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'https://evo-app-aiop.onrender.com'; 

        // --- GLOBAL STATE ---
        let currentServer = null;
        let isUserLoggedIn = false;

        // --- DOM ELEMENTS ---
        const allPages = document.querySelectorAll('.page-view, #landing-page');
        const landingPage = document.getElementById('landing-page');
        const serverDashboard = document.getElementById('server-dashboard');
        const serverSettings = document.getElementById('server-settings');
        const termsPage = document.getElementById('terms-page');
        const privacyPage = document.getElementById('privacy-page');
        const addServerModal = document.getElementById('add-server-modal');
        const removeConfirmModal = document.getElementById('remove-confirm-modal');
        const premiumFields = document.getElementById('premium-fields');
        const premiumOverlay = document.getElementById('premium-overlay');
        const userInfoDiv = document.getElementById('user-info');
        const loginBtn = document.getElementById('login-btn');
        const addServerCard = document.getElementById('add-server-card');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const removeServerBtn = document.getElementById('remove-server-btn');
        const cancelRemoveBtn = document.getElementById('cancel-remove-btn');
        const confirmRemoveBtn = document.getElementById('confirm-remove-btn');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const useRecommendedModelBtn = document.getElementById('use-recommended-model-btn');
        const serverGrid = document.getElementById('server-grid');
        const modalServerList = document.getElementById('modal-server-list');
        const termsLink = document.getElementById('terms-link');
        const privacyLink = document.getElementById('privacy-link');
        const goBackBtns = document.querySelectorAll('.go-back-btn');

        // --- PAGE NAVIGATION LOGIC ---
        function showPage(pageId) {
            allPages.forEach(p => p.style.display = 'none');
            const page = document.getElementById(pageId);
            if (page) page.style.display = 'block';
            else landingPage.style.display = 'block';
        }

        loginBtn.href = `${API_BASE_URL}/login`;
        addServerCard.addEventListener('click', () => { loadAndRenderModalServerList(); addServerModal.style.display = 'flex'; });
        closeModalBtn.addEventListener('click', () => addServerModal.style.display = 'none');
        backToDashboardBtn.addEventListener('click', () => { loadAndRenderServerDashboard(); showPage('server-dashboard'); });
        logoutBtn.addEventListener('click', async () => { await fetch(`${API_BASE_URL}/logout`, {credentials: 'include'}); isUserLoggedIn = false; showPage('landing-page'); });
        removeServerBtn.addEventListener('click', () => removeConfirmModal.style.display = 'flex');
        cancelRemoveBtn.addEventListener('click', () => removeConfirmModal.style.display = 'none');
        saveSettingsBtn.addEventListener('click', () => { if (currentServer) saveSettingsForServer(currentServer); });
        confirmRemoveBtn.addEventListener('click', () => { if(currentServer) removeServer(currentServer.id); });
        subscribeBtn.addEventListener('click', () => { premiumOverlay.style.display = 'none'; premiumFields.classList.remove('blur-md', 'pointer-events-none'); });
        useRecommendedModelBtn.addEventListener('click', () => { document.getElementById('ai-model').value = 'gemini-2.5-flash-lite'; });
        termsLink.addEventListener('click', () => showPage('terms-page'));
        privacyLink.addEventListener('click', () => showPage('privacy-page'));
        goBackBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (isUserLoggedIn) showPage('server-dashboard');
                else showPage('landing-page');
            });
        });

        // --- API & DYNAMIC RENDERING LOGIC ---
        const fetchOptions = { credentials: 'include' };

        async function updateUserInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/me`, fetchOptions);
                if (!response.ok) { isUserLoggedIn = false; return; }
                const user = await response.json();
                isUserLoggedIn = true;
                userInfoDiv.innerHTML = `<p class="font-bold text-white">${user.username}</p><p class="text-xs text-gray-400">#${user.discriminator}</p>`;
            } catch(e) { isUserLoggedIn = false; console.error("Could not fetch user info", e); }
        }

        async function loadAndRenderServerDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user-servers`, fetchOptions);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const userServers = await response.json();
                
                serverGrid.innerHTML = ''; 
                userServers.forEach(server => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl aspect-square flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-indigo-400 transition-all p-4';
                    card.innerHTML = `<div class="text-center"><img src="${server.icon}" alt="${server.name}" class="w-16 h-16 rounded-full mx-auto mb-2"><p class="font-semibold text-white truncate">${server.name}</p></div>`;
                    card.addEventListener('click', () => showSettingsForServer(server));
                    serverGrid.appendChild(card);
                });
                serverGrid.appendChild(addServerCard);
            } catch (error) { console.error('Failed to load user servers:', error); }
        }

        async function loadAndRenderModalServerList() {
            try {
                const [userServersRes, availableServersRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/user-servers`, fetchOptions),
                    fetch(`${API_BASE_URL}/api/available-servers`, fetchOptions)
                ]);
                if (!userServersRes.ok || !availableServersRes.ok) throw new Error(`HTTP error!`);
                const userServers = await userServersRes.json();
                const allAvailableServers = await availableServersRes.json();
                const userServerIds = new Set(userServers.map(s => s.id));
                const filteredServers = allAvailableServers.filter(s => !userServerIds.has(s.id));

                modalServerList.innerHTML = '';
                if (filteredServers.length === 0) {
                    modalServerList.innerHTML = `<p class="p-4 text-center text-gray-400">No new servers to add.</p>`;
                    return;
                }
                filteredServers.forEach(server => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center p-3 hover:bg-gray-700 rounded-lg cursor-pointer';
                    item.innerHTML = `<img src="${server.icon}" alt="${server.name}" class="w-10 h-10 rounded-full mr-4"><span class="font-semibold">${server.name}</span>`;
                    item.addEventListener('click', () => showSettingsForServer(server));
                    modalServerList.appendChild(item);
                });
            } catch (error) { console.error('Failed to load available servers:', error); }
        }
        
        async function removeServer(serverId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/remove-server/${serverId}`, { method: 'DELETE', ...fetchOptions });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                removeConfirmModal.style.display = 'none';
                await loadAndRenderServerDashboard();
                showPage('server-dashboard');
            } catch (error) { console.error('Failed to remove server:', error); }
        }

        async function saveSettingsForServer(server) {
            const settings = {
                server_name: server.name,
                ai_model: document.getElementById('ai-model').value,
                api_key: document.getElementById('api-key').value,
                backup_api_key: document.getElementById('backup-api-key').value,
                custom_name: document.getElementById('custom-name').value,
                custom_personality: document.getElementById('custom-personality').value
            };
            saveSettingsBtn.textContent = 'Saving...';
            saveSettingsBtn.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/api/server-settings/${server.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings),
                    ...fetchOptions
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                alert('Settings saved!');
                await loadAndRenderServerDashboard();
                showPage('server-dashboard');
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('Could not save settings.');
            } finally {
                saveSettingsBtn.textContent = 'Save Settings';
                saveSettingsBtn.disabled = false;
            }
        }

        function showSettingsForServer(server) {
            currentServer = server;
            document.getElementById('settings-server-icon').src = server.icon;
            document.getElementById('settings-server-name').textContent = server.name;
            document.getElementById('ai-model').value = '';
            document.getElementById('api-key').value = '';
            document.getElementById('backup-api-key').value = '';
            document.getElementById('custom-name').value = '';
            const personalityTextarea = document.getElementById('custom-personality');
            personalityTextarea.value = '';
            personalityTextarea.placeholder = "You are Evo. Your persona is that of a sharp-witted and humorous tomboy...";
            updateKeyDisplay('api-key', 'api-key-display');
            updateKeyDisplay('backup-api-key', 'backup-api-key-display');
            premiumOverlay.style.display = 'flex';
            premiumFields.classList.add('blur-md', 'pointer-events-none');
            showPage('server-settings');
        }

        function updateKeyDisplay(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            if (input.value.length > 4) display.textContent = '...' + input.value.slice(-4);
            else if (input.value.length > 0) display.textContent = '...';
            else display.textContent = 'None';
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('loggedin') === 'true') {
                history.pushState(null, '', window.location.pathname);
                await updateUserInfo();
                if(isUserLoggedIn) {
                    loadAndRenderServerDashboard();
                    showPage('server-dashboard');
                }
            } else {
                await updateUserInfo();
                if (isUserLoggedIn) {
                    loadAndRenderServerDashboard();
                    showPage('server-dashboard');
                } else {
                    showPage('landing-page');
                }
            }
        });
    </script>
</body>
</html>
